<?php
// Tạo shortcode [contact_form_button] để chèn vào trang
add_shortcode('contact_form_button', 'render_contact_form_button');

function render_contact_form_button() {
    ob_start(); // Bắt đầu lưu output
    ?>
    <div class="contact-button-container">
        <button id="contactButton" class="contact-btn">Liên hệ</button>
        
        <div id="contactFormModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Liên hệ với chúng tôi</h2>
                <form id="contactForm" method="post">
                    <?php wp_nonce_field('contact_form_nonce', 'contact_nonce'); ?>
                    <input type="hidden" name="action" value="send_contact_email">
                    
                    <div class="form-group">
                        <label for="fullname">Họ và tên:</label>
                        <input type="text" id="fullname" name="fullname" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="phone">Điện thoại:</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="message">Nội dung liên hệ:</label>
                        <textarea id="message" name="message" rows="4" required></textarea>
                    </div>
                    
                    <button type="submit" class="submit-btn">Gửi</button>
                    <div id="formResponse" style="margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    </div>

    <style>
    .contact-btn {
        background-color: #4CAF50;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
    }
    .contact-btn:hover { background-color: #45a049; }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 5px;
    }
    .close { color: #aaa; float: right; font-size: 28px; cursor: pointer; }
    .close:hover { color: black; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input, .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .submit-btn {
        background-color: #2196F3;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .submit-btn:hover { background-color: #0b7dda; }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mở modal khi nhấn nút "Liên hệ"
        document.getElementById("contactButton").onclick = function() {
            document.getElementById("contactFormModal").style.display = "block";
        };
        
        // Đóng modal khi nhấn nút X
        document.getElementsByClassName("close")[0].onclick = function() {
            document.getElementById("contactFormModal").style.display = "none";
        };
        
        // Đóng modal khi nhấn bên ngoài
        window.onclick = function(event) {
            if (event.target == document.getElementById("contactFormModal")) {
                document.getElementById("contactFormModal").style.display = "none";
            }
        };
        
        // Xử lý gửi form bằng AJAX
        document.getElementById("contactForm").addEventListener("submit", function(e) {
            e.preventDefault();
            
            var formData = new FormData(this);
            var responseElement = document.getElementById("formResponse");
            
            fetch("<?php echo admin_url('admin-ajax.php'); ?>", {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    responseElement.innerHTML = '<div style="color: green;">' + data.message + '</div>';
                    document.getElementById("contactForm").reset();
                    setTimeout(() => {
                        document.getElementById("contactFormModal").style.display = "none";
                        responseElement.innerHTML = "";
                    }, 2000);
                } else {
                    responseElement.innerHTML = '<div style="color: red;">' + data.message + '</div>';
                }
            })
            .catch(error => {
                responseElement.innerHTML = '<div style="color: red;">Lỗi kết nối. Vui lòng thử lại.</div>';
            });
        });
    });
    </script>
    <?php
    return ob_get_clean(); // Trả về HTML
}

// Xử lý gửi email
add_action('wp_ajax_send_contact_email', 'handle_contact_form_submission');
add_action('wp_ajax_nopriv_send_contact_email', 'handle_contact_form_submission');

function handle_contact_form_submission() {
    // Kiểm tra nonce để bảo mật
    if (!isset($_POST['contact_nonce']) || !wp_verify_nonce($_POST['contact_nonce'], 'contact_form_nonce')) {
        wp_send_json_error(array('message' => 'Lỗi bảo mật. Vui lòng tải lại trang.'));
        return;
    }

    // Kiểm tra các trường bắt buộc
    if (empty($_POST['fullname']) || empty($_POST['email']) || empty($_POST['message'])) {
        wp_send_json_error(array('message' => 'Vui lòng điền đầy đủ thông tin.'));
        return;
    }

    // Làm sạch dữ liệu
    $fullname = sanitize_text_field($_POST['fullname']);
    $phone = sanitize_text_field($_POST['phone']);
    $email = sanitize_email($_POST['email']);
    $message = sanitize_textarea_field($_POST['message']);

    // Kiểm tra email hợp lệ
    if (!is_email($email)) {
        wp_send_json_error(array('message' => 'Email không hợp lệ.'));
        return;
    }

    // Thiết lập email
    $to = 'votuongkhabvtt@gmail.com';
    $subject = 'Liên hệ mới từ ' . $fullname;
    $headers = array(
        'Content-Type: text/html; charset=UTF-8',
        'From: ' . $fullname . ' <' . $email . '>',
        'Reply-To: ' . $fullname . ' <' . $email . '>'
    );

    // Nội dung email (HTML)
    $email_content = "
        <h2>Thông tin liên hệ mới</h2>
        <p><strong>Họ tên:</strong> $fullname</p>
        <p><strong>Điện thoại:</strong> $phone</p>
        <p><strong>Email:</strong> $email</p>
        <p><strong>Nội dung:</strong></p>
        <p>$message</p>
    ";

    // Gửi email
    $mail_sent = wp_mail($to, $subject, $email_content, $headers);

    if ($mail_sent) {
        wp_send_json_success(array('message' => 'Cảm ơn bạn! Chúng tôi sẽ liên hệ sớm.'));
    } else {
        wp_send_json_error(array('message' => 'Lỗi khi gửi email. Vui lòng thử lại.'));
    }
}
