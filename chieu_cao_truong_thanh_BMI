<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·∫©n ƒêo√°n v√† D·ª± B√°o Chi·ªÅu Cao - BMI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header and Navigation */
        .header {
            text-align: center;
            padding: 15px;
            border-bottom: 2px solid #007bff;
            background-color: white;
        }

        .header h1 {
            margin: 0;
            color: #0056b3;
            font-size: 1.8em;
        }

        .header p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .navbar {
            display: flex;
            justify-content: center;
            background-color: #007bff;
            padding: 10px 0;
            margin-bottom: 20px;
        }

        .navbar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .navbar a:nth-child(1) { background-color: #0056b3; } /* Trang ch·ªß */
        .navbar a:nth-child(2) { background-color: #28a745; } /* D·ªãch v·ª• */
        .navbar a:nth-child(3) { background-color: #ffc107; } /* ƒê·∫∑t l·ªãch */
        .navbar a:nth-child(4) { background-color: #dc3545; } /* Li√™n h·ªá */

        .navbar a:hover {
            opacity: 0.9;
        }

        /* Form Styling */
        .form-container, .result-page {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .form-container h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #007bff;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }

        #girlSpecificQuestions {
            display: none; /* Hidden by default */
        }

        .submit-btn {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 20px;
        }

        .submit-btn button {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            color: white;
            background-color: #28a745;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn button:hover {
            background-color: #218838;
        }

        /* Result Page Styling */
        #resultContainer {
            display: none;
            margin-top: 30px;
        }
        .result-page {
            border: 1px solid #ddd;
            background-color: #f0f8ff; /* Light blue background */
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px;
        }

        .result-header img {
            max-width: 150px;
            opacity: 0.8;
        }

        .result-title h2 {
            color: #0056b3;
            margin: 0;
        }

        .result-section {
            margin-bottom: 25px;
        }

        .result-section h3 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .result-item {
            background-color: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .result-item p {
            margin: 0 0 10px 0;
        }
        #resBoneAgeFormula {
            font-style: italic;
            font-size: 0.9em;
            color: #555;
            background-color: #e9ecef;
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 5px;
        }

        .result-footer {
            text-align: right;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        
        .action-buttons {
             display: flex;
             justify-content: center;
             gap: 20px;
             margin-top: 30px;
        }

        .action-buttons button {
             padding: 10px 25px;
             border: none;
             border-radius: 5px;
             color: white;
             font-size: 1em;
             cursor: pointer;
        }
        .print-btn { background-color: #007bff; }
        .reset-btn { background-color: #6c757d; }


        @media print {
            body * {
                visibility: hidden;
            }
            .result-page, .result-page * {
                visibility: visible;
            }
            .result-page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 10mm;
                box-shadow: none;
                border: none;
                background-color: #f0f8ff !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            .navbar, .form-container, .action-buttons {
                display: none;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>Ph√≤ng kh√°m YHCT v√† YHTT PGS.TS.BS. V√µ T∆∞·ªùng Kha</h1>
        <p>Web: votuongkha.net | Tel: 0913504755 | Email: votuongkhabvtt@gmail.com</p>
    </div>

    <nav class="navbar">
        <a href="http://votuongkha.net" target="_blank">Trang ch·ªß</a>
        <a href="https://forms.gle/mqCBZZnT2nxR43WS8" target="_blank">D·ªãch v·ª•</a>
        <a href="https://forms.gle/ikK8uFukM86wxpM46" target="_blank">ƒê·∫∑t l·ªãch</a>
        <a href="tel:0913504755">Li√™n h·ªá (0913504755)</a>
    </nav>

    <div class="container">
        <div class="form-container" id="formWrapper">
            <h2>Phi·∫øu Th√¥ng Tin Kh√°ch H√†ng</h2>
            <form id="diagnosisForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="fullName">H·ªç t√™n kh√°ch h√†ng</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="dob">Ng√†y th√°ng nƒÉm sinh</label>
                        <input type="date" id="dob" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Gi·ªõi t√≠nh</label>
                        <select id="gender" required>
                            <option value="">Ch·ªçn gi·ªõi t√≠nh...</option>
                            <option value="male">B√© trai</option>
                            <option value="female">B√© g√°i</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="address">ƒê·ªãa ch·ªâ n∆°i ·ªü</label>
                        <input type="text" id="address">
                    </div>
                    <div class="form-group">
                        <label for="phone">ƒêi·ªán tho·∫°i</label>
                        <input type="tel" id="phone">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email">
                    </div>
                    <div class="form-group">
                        <label for="currentHeight">Chi·ªÅu cao hi·ªán t·∫°i (cm)</label>
                        <input type="number" id="currentHeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="currentWeight">C√¢n n·∫∑ng hi·ªán t·∫°i (kg)</label>
                        <input type="number" id="currentWeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="fatherHeight">Chi·ªÅu cao c·ªßa b·ªë (cm)</label>
                        <input type="number" id="fatherHeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="motherHeight">Chi·ªÅu cao c·ªßa m·∫π (cm)</label>
                        <input type="number" id="motherHeight" step="0.1" required>
                    </div>
                     <div class="form-group">
                        <label for="boneAge">Tu·ªïi x∆∞∆°ng b√†n tay kh√¥ng thu·∫≠n (nƒÉm)</label>
                        <input type="number" id="boneAge" step="0.1" required>
                    </div>
                    
                    <div id="girlSpecificQuestions" class="form-group">
                        <label for="pubertyStatus">T√¨nh tr·∫°ng d·∫≠y th√¨</label>
                        <select id="pubertyStatus">
                            <option value="pre">Ch∆∞a d·∫≠y th√¨</option>
                            <option value="post">ƒê√£ d·∫≠y th√¨ (ƒë√£ c√≥ kinh nguy·ªát)</option>
                        </select>
                    </div>

                </div>
                <div class="submit-btn">
                    <button type="submit">Xem K·∫øt Qu·∫£ Ch·∫©n ƒêo√°n</button>
                </div>
            </form>
        </div>

        <div id="resultContainer">
            <div class="result-page" id="printableArea">
                <div class="result-header">
                    <div class="result-title">
                        <h2>PHI·∫æU K·∫æT QU·∫¢ PH√ÇN T√çCH TƒÇNG TR∆Ø·ªûNG</h2>
                        <p>D·ª± b√°o Chi·ªÅu cao & Ph√¢n lo·∫°i BMI</p>
                    </div>
                    <img src="https://i.ibb.co/6rW8pWp/doctor-icon.png" alt="B√°c s·ªπ v√† em b√©">
                </div>

                <div class="result-section">
                    <h3>I. Th√¥ng Tin B·ªánh Nh√¢n</h3>
                    <p><strong>H·ªç v√† t√™n:</strong> <span id="resFullName"></span></p>
                    <p><strong>Ng√†y sinh:</strong> <span id="resDob"></span></p>
                     <p><strong>Tu·ªïi hi·ªán t·∫°i:</strong> <span id="resCurrentAge"></span></p>
                    <p><strong>Gi·ªõi t√≠nh:</strong> <span id="resGender"></span></p>
                </div>
                
                <div class="result-section">
                    <h3>II. Ph√¢n T√≠ch Hi·ªán T·∫°i</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <p><strong>Chi·ªÅu cao:</strong> <span id="resCurrentHeight"></span> cm</p>
                            <p><strong>Ph√¢n lo·∫°i chi·ªÅu cao:</strong> <span id="resHeightClass"></span></p>
                        </div>
                         <div class="result-item">
                            <p><strong>C√¢n n·∫∑ng:</strong> <span id="resCurrentWeight"></span> kg</p>
                            <p><strong>Ch·ªâ s·ªë BMI:</strong> <span id="resBmi"></span></p>
                            <p><strong>Ph√¢n lo·∫°i BMI:</strong> <span id="resBmiClass"></span></p>
                        </div>
                    </div>
                </div>

                <div class="result-section">
                    <h3>III. D·ª± B√°o Chi·ªÅu Cao Tr∆∞·ªüng Th√†nh (L√∫c 18 tu·ªïi)</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <p><strong>Theo di truy·ªÅn (b·ªë m·∫π):</strong> <span id="resGeneticHeight"></span> cm</p>
                        </div>
                        <div class="result-item">
                            <p><strong>Theo tu·ªïi x∆∞∆°ng:</strong> <span id="resBoneAgeHeight"></span> cm</p>
                            <p><strong>Ph√¢n lo·∫°i d·ª± b√°o:</strong> <span id="resPredictedHeightClass"></span></p>
                            <p id="resBoneAgeFormula"></p>
                        </div>
                    </div>
                </div>

                 <div class="result-section">
                    <h3>IV. Bi·ªÉu ƒê·ªì TƒÉng Tr∆∞·ªüng (So v·ªõi chu·∫©n WHO)</h3>
                    <div class="chart-container">
                         <canvas id="heightChart"></canvas>
                    </div>
                     <div class="chart-container">
                         <canvas id="bmiChart"></canvas>
                    </div>
                </div>

                <div class="result-section">
                    <h3>V. Nh·∫≠n X√©t v√† K·∫øt Lu·∫≠n</h3>
                    <div id="finalConclusion"></div>
                </div>

                <div class="result-footer">
                    <p id="reportDate"></p>
                    <p><strong>B√°c s·ªπ k√Ω t√™n</strong></p>
                    <br><br>
                    <p><strong>PGS.TS.BS. V√µ T∆∞·ªùng Kha</strong></p>
                </div>
            </div>
             <div class="action-buttons">
                <button class="print-btn" onclick="window.print()">üñ®Ô∏è In K·∫øt Qu·∫£</button>
                <button class="reset-btn" id="resetFormBtn">üîÑ Ch·∫©n ƒêo√°n M·ªõi</button>
            </div>
        </div>
    </div>

<script>
// --- DATA SECTION ---
// Data from "D·ª± b√°o chi·ªÅu cao b√© trai"
const boyCoefficients = {
    "8": { "CoC": 1.22, "CoT": -7.2, "COTX": -0.4, "Hs": 82 }, "8.5": { "CoC": 1.23, "CoT": -7.0, "COTX": -0.7, "Hs": 82 },
    "9": { "CoC": 1.22, "CoT": -6.8, "COTX": -0.8, "Hs": 82 }, "9.5": { "CoC": 1.21, "CoT": -6.5, "COTX": -0.8, "Hs": 82 },
    "10": { "CoC": 1.2, "CoT": -6.2, "COTX": -1.0, "Hs": 83 }, "10.5": { "CoC": 1.19, "CoT": -5.9, "COTX": -1.2, "Hs": 84 },
    "11": { "CoC": 1.16, "CoT": -5.5, "COTX": -1.6, "Hs": 89 }, "11.5": { "CoC": 1.13, "CoT": -5.1, "COTX": -2.0, "Hs": 94 },
    "12": { "CoC": 1.08, "CoT": -4.2, "COTX": -2.6, "Hs": 98 }, "12.5": { "CoC": 1.03, "CoT": -3.4, "COTX": -3.2, "Hs": 103 },
    "13": { "CoC": 0.98, "CoT": -2.6, "COTX": -3.8, "Hs": 108 }, "13.5": { "CoC": 0.94, "CoT": -1.9, "COTX": -4.4, "Hs": 113 },
    "14": { "CoC": 0.9, "CoT": -1.4, "COTX": -4.5, "Hs": 113 }, "14.5": { "CoC": 0.87, "CoT": -1.0, "COTX": -4.6, "Hs": 114 },
    "15": { "CoC": 0.84, "CoT": -0.8, "COTX": -3.8, "Hs": 104 }, "15.5": { "CoC": 0.82, "CoT": -0.6, "COTX": -3.1, "Hs": 94 },
    "16": { "CoC": 0.88, "CoT": -0.4, "COTX": -2.4, "Hs": 70 }, "16.5": { "CoC": 0.94, "CoT": -0.3, "COTX": -1.8, "Hs": 48 },
    "17": { "CoC": 0.96, "CoT": -0.2, "COTX": -1.2, "Hs": 32 }, "17.5": { "CoC": 0.96, "CoT": -0.2, "COTX": -1.2, "Hs": 33 },
    "18": { "CoC": 0.97, "CoT": -0.2, "COTX": -1.2, "Hs": 32 }
};
        
// D·ªØ li·ªáu h·ªá s·ªë cho b√© g√°i ch∆∞a d·∫≠y th√¨
const girlPrePubertyCoefficients = {
"4": { "CoC": 0.95, "CoT": -6.5, "COTX": 0, "Hs": 93 },
"5": { "CoC": 0.95, "CoT": -6.5, "COTX": 0, "Hs": 93 },
"6": { "CoC": 0.95, "CoT": -6, "COTX": -0.4, "Hs": 93 },
"6.5": { "CoC": 0.95, "CoT": -5.5, "COTX": -0.8, "Hs": 93 },
"7": { "CoC": 0.94, "CoT": -5.1, "COTX": -1, "Hs": 93 },
"7.5": { "CoC": 0.93, "CoT": -4.7, "COTX": -1.1, "Hs": 94 },
"8": { "CoC": 0.92, "CoT": -4.4, "COTX": -1.5, "Hs": 95 },
"8.5": { "CoC": 0.92, "CoT": -4, "COTX": -1.9, "Hs": 96 },
"9": { "CoC": 0.92, "CoT": -3.8, "COTX": -2.3, "Hs": 96 },
"9.5": { "CoC": 0.91, "CoT": -3.6, "COTX": -2.7, "Hs": 100 },
"10": { "CoC": 0.89, "CoT": -3.2, "COTX": -3.2, "Hs": 104 },
"10.5": { "CoC": 0.87, "CoT": -2.7, "COTX": -3.6, "Hs": 107 },
"11": { "CoC": 0.83, "CoT": -2.6, "COTX": -3.6, "Hs": 111 },
"11.5": { "CoC": 0.82, "CoT": -2.5, "COTX": -3.6, "Hs": 112 },
"12": { "CoC": 0.83, "CoT": -2.4, "COTX": -3.4, "Hs": 108 },
"12.5": { "CoC": 0.83, "CoT": -2.3, "COTX": -3.4, "Hs": 107 },
"13": { "CoC": 0.85, "CoT": -2, "COTX": -3.1, "Hs": 97 },
"13.5": { "CoC": 0.87, "CoT": -1.8, "COTX": -3, "Hs": 91 },
"14": { "CoC": 0.91, "CoT": -1.6, "COTX": -2.8, "Hs": 80 },
"14.5": { "CoC": 0.99, "CoT": -1.4, "COTX": -2.5, "Hs": 61 }
};
        
// D·ªØ li·ªáu h·ªá s·ªë cho b√© g√°i ƒë√£ d·∫≠y th√¨
const girlPostPubertyCoefficients = {
            "11": { "CoC": 0.87, "CoT": -2.3, "COTX": -3.3, "Hs": 99 },
"11.5": { "CoC": 0.89, "CoT": -1.9, "COTX": -3.3, "Hs": 92 },
"12": { "CoC": 0.91, "CoT": -1.4, "COTX": -3.2, "Hs": 81 },
"12.5": { "CoC": 0.93, "CoT": -1, "COTX": -2.7, "Hs": 67 },
"13": { "CoC": 0.95, "CoT": -0.9, "COTX": -2.2, "Hs": 55 },
"13.5": { "CoC": 0.96, "CoT": -0.9, "COTX": -1.8, "Hs": 48 },
"14": { "CoC": 0.96, "CoT": -0.8, "COTX": -1.4, "Hs": 41 },
"14.5": { "CoC": 0.97, "CoT": -0.8, "COTX": -1.3, "Hs": 38 },
"15": { "CoC": 0.98, "CoT": -0.6, "COTX": -1.1, "Hs": 28 },
"15.5": { "CoC": 0.99, "CoT": -0.4, "COTX": -0.7, "Hs": 20 },
"16": { "CoC": 0.99, "CoT": -0.4, "COTX": -0.7, "Hs": 20 },
"16.5": { "CoC": 0.99, "CoT": -0.4, "COTX": -0.7, "Hs": 21 },
"17": { "CoC": 0.99, "CoT": -0.4, "COTX": -0.7, "Hs": 21 },
"17.5": { "CoC": 0.99, "CoT": -0.4, "COTX": -0.7, "Hs": 21 }
};
// Simplified WHO LMS data for demonstration. 
const whoData = {
    male: {
        height: { 61: {l:1,m:110.3,s:0.0417}, 84: {l:1,m:121.7,s:0.0416}, 120: {l:1,m:137.5,s:0.0441}, 180: {l:1,m:170.1,s:0.0447}, 228: {l:1,m:176.5,s:0.042} },
        bmi: { 61: {l:-0.7387,m:15.2641,s:0.08390}, 84: {l:-1.0289,m:15.3418,s:0.08984}, 120: {l:-1.618,m:16.4227,s:0.10842}, 180: {l:-1.7423,m:20.893,s:0.15579}, 228: {l:-0.9669,m:22.7317,s:0.16975} }
    },
    female: {
        height: { 61: {l:1,m:109.6,s:0.043}, 84: {l:1,m:120.8,s:0.0435}, 120: {l:1,m:138.6,s:0.048}, 144: {l:1,m:151.7,s:0.052}, 228: {l:1,m:163.2,s:0.041} },
        bmi: { 61: {l:-0.8886,m:15.2441,s:0.09692}, 84: {l:-1.0371,m:15.2014,s:0.10013}, 120: {l:-1.3359,m:16.5946,s:0.12354}, 144: {l:-1.3361,m:18.2435,s:0.14925}, 228: {l:-0.6695,m:22.8256,s:0.19179} }
    }
};

// --- LOGIC SECTION ---
class Diagnosis {
    constructor(inputs) {
        this.inputs = inputs;
        this.results = {};
        this.calculate();
    }
    
    calculate() {
        this.calculateAge();
        this.calculateBMI();
        this.predictGeneticHeight();
        this.predictBoneAgeHeight();
        this.classifyAll();
    }
    
    calculateAge() {
        const ageDecimal = (new Date() - new Date(this.inputs.dob)) / (1000 * 60 * 60 * 24 * 365.25);
        this.results.age = parseFloat(ageDecimal.toFixed(2));
        this.results.ageInMonths = Math.floor(this.results.age * 12);
    }

    calculateBMI() {
        this.results.bmi = parseFloat((this.inputs.currentWeight / Math.pow(this.inputs.currentHeight / 100, 2)).toFixed(2));
    }

    predictGeneticHeight() {
        const midParentalHeight = (this.inputs.fatherHeight + this.inputs.motherHeight) / 2;
        this.results.geneticHeight = parseFloat((midParentalHeight + (this.inputs.gender === 'male' ? 6.5 : -6.5)).toFixed(1));
    }

    predictBoneAgeHeight() {
        const boneAge = this.inputs.boneAge;
        const decimalPart = boneAge % 1;
        let roundedBoneAge;
        if (decimalPart <= 0.3) roundedBoneAge = Math.floor(boneAge);
        else if (decimalPart < 0.7) roundedBoneAge = Math.floor(boneAge) + 0.5;
        else roundedBoneAge = Math.ceil(boneAge);

        let coeffsTable;
        if (this.inputs.gender === 'male') coeffsTable = boyCoefficients;
        else coeffsTable = this.inputs.pubertyStatus === 'pre' ? girlPrePubertyCoefficients : girlPostPubertyCoefficients;
        
        const coeffs = coeffsTable[roundedBoneAge];
        this.results.boneAgeCoeffs = coeffs; // Store coeffs for display

        if (!coeffs) {
            this.results.boneAgeHeight = "Kh√¥ng c√≥ d·ªØ li·ªáu cho tu·ªïi x∆∞∆°ng n√†y";
            return;
        }
        
        const predictedHeight = (coeffs.CoC * this.inputs.currentHeight) + (coeffs.CoT * boneAge) + coeffs.COTX + coeffs.Hs;
        this.results.boneAgeHeight = parseFloat(predictedHeight.toFixed(1));
    }
    
    getZScore(type, ageInMonths, value) {
        const data = whoData[this.inputs.gender][type];
        const ageKeys = Object.keys(data).map(Number);
        let nearestAge = ageKeys.reduce((prev, curr) => Math.abs(curr - ageInMonths) < Math.abs(prev - ageInMonths) ? curr : prev);
        const { l, m, s } = data[nearestAge];
        if (l === 0) return Math.log(value / m) / s;
        return (Math.pow(value / m, l) - 1) / (l * s);
    }
    
    classifyAll() {
        // BMI Classification
        const bmiZScore = this.getZScore('bmi', this.results.ageInMonths, this.results.bmi);
        if (bmiZScore < -2) this.results.bmiClassification = "G·∫ßy (d∆∞·ªõi -2SD)";
        else if (bmiZScore < -1) this.results.bmiClassification = "Nguy c∆° g·∫ßy (-1SD ƒë·∫øn -2SD)";
        else if (bmiZScore <= 1) this.results.bmiClassification = "B√¨nh th∆∞·ªùng (Mean)";
        else if (bmiZScore <= 2) this.results.bmiClassification = "Th·ª´a c√¢n (+1SD ƒë·∫øn +2SD)";
        else this.results.bmiClassification = "B√©o ph√¨ (tr√™n +2SD)";
        
        // Height Classification
        const heightZScore = this.getZScore('height', this.results.ageInMonths, this.inputs.currentHeight);
        this.results.heightClassification = this.classifyHeightZScore(heightZScore);
        
        const adultHeightZScore = this.getZScore('height', 228, this.results.boneAgeHeight);
        this.results.predictedHeightClassification = this.classifyHeightZScore(adultHeightZScore, true);
    }
    
    classifyHeightZScore(zScore, isPredicted = false) {
        const terms = isPredicted ? ["L√πn", "Th·∫•p", "B√¨nh th∆∞·ªùng", "Tr·ªôi", "V∆∞·ª£t tr·ªôi"] : ["R·∫•t th·∫•p", "Th·∫•p", "B√¨nh th∆∞·ªùng", "Cao", "R·∫•t cao"];
        if (zScore < -2) return `${terms[0]} (d∆∞·ªõi -2SD)`;
        if (zScore < -1) return `${terms[1]} (-1SD ƒë·∫øn -2SD)`;
        if (zScore <= 1) return `${terms[2]} (Mean)`;
        if (zScore <= 2) return `${terms[3]} (+1SD ƒë·∫øn +2SD)`;
        return `${terms[4]} (tr√™n +2SD)`;
    }
}


// --- UI / EVENT HANDLING SECTION ---
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('diagnosisForm');
    const genderSelect = document.getElementById('gender');
    const girlSpecificQuestions = document.getElementById('girlSpecificQuestions');
    let heightChartInstance, bmiChartInstance;

    genderSelect.addEventListener('change', () => {
        girlSpecificQuestions.style.display = genderSelect.value === 'female' ? 'flex' : 'none';
    });
    
    document.getElementById('resetFormBtn').addEventListener('click', () => {
        form.reset();
        girlSpecificQuestions.style.display = 'none';
        document.getElementById('resultContainer').style.display = 'none';
        document.getElementById('formWrapper').scrollIntoView({ behavior: 'smooth' });
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        const inputs = {
            fullName: document.getElementById('fullName').value, dob: document.getElementById('dob').value,
            gender: document.getElementById('gender').value,
            currentHeight: parseFloat(document.getElementById('currentHeight').value),
            currentWeight: parseFloat(document.getElementById('currentWeight').value),
            fatherHeight: parseFloat(document.getElementById('fatherHeight').value),
            motherHeight: parseFloat(document.getElementById('motherHeight').value),
            boneAge: parseFloat(document.getElementById('boneAge').value),
            pubertyStatus: document.getElementById('pubertyStatus').value
        };

        const diagnosis = new Diagnosis(inputs);
        const res = diagnosis.results;
        
        // Display basic info
        document.getElementById('resFullName').textContent = inputs.fullName;
        document.getElementById('resDob').textContent = new Date(inputs.dob).toLocaleDateString('vi-VN');
        document.getElementById('resCurrentAge').textContent = `${res.age} tu·ªïi`;
        document.getElementById('resGender').textContent = inputs.gender === 'male' ? 'B√© trai' : 'B√© g√°i';
        
        // Display current status
        document.getElementById('resCurrentHeight').textContent = inputs.currentHeight;
        document.getElementById('resHeightClass').textContent = res.heightClassification;
        document.getElementById('resCurrentWeight').textContent = inputs.currentWeight;
        document.getElementById('resBmi').textContent = res.bmi;
        document.getElementById('resBmiClass').textContent = res.bmiClassification;
        
        // Display predictions
        document.getElementById('resGeneticHeight').textContent = res.geneticHeight;
        document.getElementById('resBoneAgeHeight').textContent = res.boneAgeHeight;
        document.getElementById('resPredictedHeightClass').textContent = res.predictedHeightClassification;

        // Display detailed formula
        if (res.boneAgeCoeffs) {
            const { CoC, CoT, COTX, Hs } = res.boneAgeCoeffs;
            document.getElementById('resBoneAgeFormula').innerHTML = `<strong>Chi ti·∫øt c√¥ng th·ª©c:</strong><br>
            ($_H = (CoC \\times Cao) + (CoT \\times Tu·ªïi) + COTX + Hs$)<br>
            $_H = (${CoC} \\times ${inputs.currentHeight}) + (${CoT} \\times ${inputs.boneAge}) + (${COTX}) + ${Hs} = \\mathbf{${res.boneAgeHeight}\\,cm}$`;
        } else {
             document.getElementById('resBoneAgeFormula').textContent = "Kh√¥ng th·ªÉ t√≠nh to√°n do thi·∫øu d·ªØ li·ªáu tu·ªïi x∆∞∆°ng.";
        }
        
        // Generate and display conclusion
        document.getElementById('finalConclusion').innerHTML = `
            <p><strong>1. T√¨nh tr·∫°ng hi·ªán t·∫°i:</strong></p>
            <p style="padding-left: 20px;">
                - <u>So s√°nh v·ªõi chu·∫©n WHO cho tr·∫ª ${res.age} tu·ªïi:</u> Chi·ªÅu cao hi·ªán t·∫°i c·ªßa b√© (${inputs.currentHeight} cm) ƒë∆∞·ª£c ph√¢n lo·∫°i l√† <strong>${res.heightClassification}</strong>.
                Ch·ªâ s·ªë kh·ªëi c∆° th·ªÉ (BMI) l√† ${res.bmi}, ƒë∆∞·ª£c ph√¢n lo·∫°i l√† <strong>${res.bmiClassification}</strong>.
            </p>
            <p><strong>2. Ti·ªÅm nƒÉng ph√°t tri·ªÉn (d·ª± b√°o l√∫c 18 tu·ªïi):</strong></p>
            <p style="padding-left: 20px;">
                - Chi·ªÅu cao tr∆∞·ªüng th√†nh c·ªßa b√© ƒë∆∞·ª£c d·ª± b√°o ƒë·∫°t kho·∫£ng <strong>${res.boneAgeHeight} cm</strong> (d·ª±a tr√™n ph∆∞∆°ng ph√°p tu·ªïi x∆∞∆°ng).
                - <u>So s√°nh v·ªõi chu·∫©n WHO cho ng∆∞·ªùi tr∆∞·ªüng th√†nh:</u> M·ª©c chi·ªÅu cao n√†y ƒë∆∞·ª£c ph√¢n lo·∫°i l√† <strong>${res.predictedHeightClassification}</strong>. ƒêi·ªÅu n√†y cho th·∫•y ti·ªÅm nƒÉng ph√°t tri·ªÉn chi·ªÅu cao c·ªßa b√© so v·ªõi b·∫°n b√® c√πng trang l·ª©a khi l·ªõn l√™n.
            </p>
        `;
        
        const today = new Date();
        document.getElementById('reportDate').textContent = `H√† N·ªôi, ng√†y ${today.getDate()} th√°ng ${today.getMonth() + 1} nƒÉm ${today.getFullYear()}`;
        
        if (heightChartInstance) heightChartInstance.destroy();
        if (bmiChartInstance) bmiChartInstance.destroy();
        heightChartInstance = drawChart('height', inputs, diagnosis);
        bmiChartInstance = drawChart('bmi', inputs, diagnosis);

        document.getElementById('resultContainer').style.display = 'block';
        document.getElementById('resultContainer').scrollIntoView({ behavior: 'smooth' });
    });
    
    function getLMSValue(gender, type, zScore, ageInMonths) {
        const data = whoData[gender][type];
        const ageKeys = Object.keys(data).map(Number);
        let nearestAge = ageKeys.reduce((prev, curr) => Math.abs(curr - ageInMonths) < Math.abs(prev - ageInMonths) ? curr : prev);
        const { l, m, s } = data[nearestAge];
        if (l === 0) return m * Math.exp(s * zScore);
        return m * Math.pow((l * s * zScore) + 1, 1 / l);
    }

    function drawChart(type, inputs, diagnosis) {
        const ctx = document.getElementById(type + 'Chart').getContext('2d');
        const isHeight = type === 'height';
        const labels = Array.from({ length: 14 }, (_, i) => i + 5); // Ages 5 to 18
        
        const datasets = [-2, -1, 0, 1, 2].map(z => ({
            label: `SD ${z > 0 ? '+' : ''}${z}`,
            data: labels.map(age => getLMSValue(inputs.gender, type, z, age * 12)),
            borderColor: z === 0 ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 0.5)',
            borderWidth: z === 0 ? 3 : 2, pointRadius: 0, fill: false, tension: 0.4
        }));
        
        const patientData = {
            label: 'D·ªØ li·ªáu c·ªßa b√©', data: [], backgroundColor: 'rgba(75, 192, 192, 1)',
            borderColor: 'rgba(75, 192, 192, 1)', pointRadius: 6, pointHoverRadius: 8, fill: false,
            showLine: isHeight
        };
        
        patientData.data.push({ x: diagnosis.results.age, y: isHeight ? inputs.currentHeight : diagnosis.results.bmi });
        if (isHeight) patientData.data.push({ x: 18, y: diagnosis.results.boneAgeHeight });
        datasets.push(patientData);

        return new Chart(ctx, {
            type: 'line', data: { labels, datasets },
            options: {
                responsive: true,
                plugins: { title: { display: true, text: isHeight ? 'Bi·ªÉu ƒë·ªì Chi·ªÅu cao theo Tu·ªïi' : 'Bi·ªÉu ƒë·ªì BMI theo Tu·ªïi' } },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'Tu·ªïi (nƒÉm)' } },
                    y: { title: { display: true, text: isHeight ? 'Chi·ªÅu cao (cm)' : 'Ch·ªâ s·ªë BMI (kg/m¬≤)' } }
                }
            }
        });
    }
});
</script>

</body>
</html>
