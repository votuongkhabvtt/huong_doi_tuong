<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Tư Vấn Kiểm Soát Huyết Áp - PGs.TS.Bs. Võ Tường Kha</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #2c5530;
            --secondary: #4a7c59;
            --accent: #8fb996;
            --light: #f8f9fa;
            --dark: #343a40;
            --danger: #e74c3c;
            --success: #27ae60;
            --warning: #f39c12;
            --info: #3498db;
            --gold: #d4af37;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .clinic-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .clinic-header:before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="100" height="100" opacity="0.1"><path d="M20,20 L80,20 L80,80 L20,80 Z" fill="white" stroke="white" stroke-width="2"/><circle cx="50" cy="50" r="15" fill="white"/></svg>');
        }
        
        .clinic-name {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .doctor-name {
            font-size: 1.4rem;
            color: var(--gold);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .system-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .system-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid var(--secondary);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--accent);
        }
        
        .card-header i {
            font-size: 1.8rem;
            margin-right: 15px;
            color: var(--primary);
            background: var(--accent);
            padding: 10px;
            border-radius: 50%;
        }
        
        .card-title {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5ee;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(44, 85, 48, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(44, 85, 48, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(44, 85, 48, 0.4);
        }
        
        button i {
            margin-right: 10px;
        }
        
        .btn-print {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, var(--warning) 0%, #e67e22 100%);
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .visualization {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        canvas {
            width: 100%;
            height: 320px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border-left: 5px solid var(--primary);
        }
        
        .result-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .result-section:last-child {
            border-bottom: none;
        }
        
        .result-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent);
            display: flex;
            align-items: center;
        }
        
        .result-section h3 i {
            margin-right: 10px;
            background: var(--accent);
            padding: 8px;
            border-radius: 50%;
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px dashed #e1e5ee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .result-value {
            color: var(--primary);
            font-weight: 600;
            text-align: right;
        }
        
        .highlight {
            background: linear-gradient(135deg, #fff9c4 0%, #fff176 100%);
            padding: 12px 15px;
            border-radius: 10px;
            border-left: 4px solid var(--warning);
            margin: 10px 0;
        }
        
        .nutrition-chart {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .nutrition-item {
            text-align: center;
            padding: 20px 15px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .protein {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        }
        
        .carbs {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }
        
        .fat {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .bp-status {
            padding: 12px 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .bp-normal {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .bp-elevated {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .bp-hypertension {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .meal-plan {
            background: #f8fff8;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e8f5e9;
        }
        
        .meal-item {
            display: flex;
            justify-content: space-between;
            background: white;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid var(--success);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--dark);
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .dashboard, .visualization {
                grid-template-columns: 1fr;
            }
            
            .nutrition-chart {
                grid-template-columns: 1fr;
            }
            
            .result-grid {
                grid-template-columns: 1fr;
            }
            
            .clinic-name {
                font-size: 1.8rem;
            }
            
            .doctor-name {
                font-size: 1.2rem;
            }
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .btn-group, .card:not(.result-card), .footer, .visualization {
                display: none;
            }
            
            .result-card {
                box-shadow: none;
                border: 1px solid #ddd;
                margin: 0;
                padding: 15px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .clinic-header {
                margin-bottom: 15px;
                padding: 15px;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="clinic-header">
            <div class="clinic-name">PHÒNG KHÁM ĐA KHOA YHTT & YHCT</div>
            <div class="doctor-name">PGs.TS.Bs. Võ Tường Kha</div>
            <div class="system-name">HỆ THỐNG TƯ VẤN KIỂM SOÁT HUYẾT ÁP</div>
            <div class="system-subtitle">Kết hợp Y học Thể thao & Y học Cổ truyền trong phòng ngừa và điều trị</div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-injured"></i>
                    <h2 class="card-title">THÔNG TIN BỆNH NHÂN</h2>
                </div>
                <div class="form-group">
                    <label for="patientName"><i class="fas fa-signature"></i> Họ và tên</label>
                    <input type="text" id="patientName" placeholder="Nhập họ tên đầy đủ">
                </div>
                <div class="form-group">
                    <label for="patientGender"><i class="fas fa-venus-mars"></i> Giới tính</label>
                    <select id="patientGender">
                        <option value="male">Nam</option>
                        <option value="female">Nữ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="patientDob"><i class="fas fa-birthday-cake"></i> Ngày tháng năm sinh</label>
                    <input type="date" id="patientDob">
                </div>
                <div class="form-group">
                    <label for="patientAddress"><i class="fas fa-home"></i> Địa chỉ</label>
                    <textarea id="patientAddress" rows="2" placeholder="Nhập địa chỉ liên hệ"></textarea>
                </div>
                <div class="form-group">
                    <label for="patientOccupation"><i class="fas fa-briefcase"></i> Nghề nghiệp</label>
                    <input type="text" id="patientOccupation" placeholder="Nhập nghề nghiệp hiện tại">
                </div>
                <div class="form-group">
                    <label for="activityLevel"><i class="fas fa-running"></i> Loại lao động (Hệ số hoạt động)</label>
                    <select id="activityLevel">
                        <option value="sedentary">Ít vận động (hệ số 1.2)</option>
                        <option value="light">Vận động nhẹ (hệ số 1.375)</option>
                        <option value="moderate">Vận động vừa phải (hệ số 1.55)</option>
                        <option value="high">Vận động nặng (hệ số 1.725)</option>
                        <option value="very_high">Vận động rất nặng (hệ số 1.9)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="physioFactor"><i class="fas fa-heartbeat"></i> Tình trạng sinh lý (Hệ số sinh lý)</label>
                    <select id="physioFactor">
                        <option value="normal">Bình thường (hệ số 1.0)</option>
                        <option value="pregnant">Mang thai (hệ số 1.15)</option>
                        <option value="breastfeeding">Cho con bú (hệ số 1.25)</option>
                        <option value="illness">Ốm bệnh/Nhiễm trùng (hệ số 1.2)</option>
                        <option value="post_surgery">Sau phẫu thuật/Chấn thương (hệ số 1.25)</option>
                        <option value="resting">Nghỉ ngơi (do bệnh) (hệ số 0.95)</option>
                    </select>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-stethoscope"></i>
                    <h2 class="card-title">CHỈ SỐ SỨC KHỎE</h2>
                </div>
                <div class="form-group">
                    <label for="systolic"><i class="fas fa-tachometer-alt"></i> Huyết áp tối đa (mmHg)</label>
                    <input type="number" id="systolic" placeholder="Nhập huyết áp tâm thu">
                </div>
                <div class="form-group">
                    <label for="diastolic"><i class="fas fa-tachometer-alt"></i> Huyết áp tối thiểu (mmHg)</label>
                    <input type="number" id="diastolic" placeholder="Nhập huyết áp tâm trương">
                </div>
                <div class="form-group">
                    <label for="heartRate"><i class="fas fa-heart"></i> Mạch lúc nghỉ (bpm)</label>
                    <input type="number" id="heartRate" placeholder="Nhập nhịp tim lúc nghỉ">
                </div>
                
                <div class="form-group">
                    <label for="patientHeight"><i class="fas fa-ruler-vertical"></i> Chiều cao (cm)</label>
                    <input type="number" id="patientHeight" placeholder="Nhập chiều cao">
                </div>
                
                <div class="form-group">
                    <label for="patientWeight"><i class="fas fa-weight"></i> Cân nặng (kg)</label>
                    <input type="number" id="patientWeight" placeholder="Nhập cân nặng">
                </div>
                
                <div class="highlight">
                    <i class="fas fa-info-circle"></i> Hệ thống sẽ tự động đề xuất kế hoạch tập luyện và dinh dưỡng phù hợp dựa trên thông tin của bạn.
                </div>
                
                <div class="btn-group">
                    <button id="calculateBtn"><i class="fas fa-calculator"></i> PHÂN TÍCH & TƯ VẤN</button>
                    <button id="resetBtn" class="btn-reset"><i class="fas fa-redo"></i> NHẬP LẠI</button>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loadingSection">
            <div class="loading-spinner"></div>
            <p>Đang phân tích và tính toán dữ liệu...</p>
        </div>
        
        <div class="visualization">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-pie"></i>
                    <h2 class="card-title">PHÂN BỔ DINH DƯỠNG</h2>
                </div>
                <canvas id="nutritionChart"></canvas>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-burn"></i>
                    <h2 class="card-title">NĂNG LƯỢNG TIÊU HAO & CẦN NẠP</h2>
                </div>
                <canvas id="energyChart"></canvas>
            </div>
        </div>
        
        <div class="results" id="resultsSection">
            <div class="result-card">
                <div class="card-header">
                    <i class="fas fa-file-medical-alt"></i>
                    <h2 class="card-title">KẾT QUẢ PHÂN TÍCH & TƯ VẤN</h2>
                </div>
                
                <div class="result-section">
                    <h3><i class="fas fa-user-md"></i> THÔNG TIN BỆNH NHÂN</h3>
                    <div class="result-grid">
                        <div>
                            <div class="result-item">
                                <span class="result-label">Họ tên:</span>
                                <span class="result-value" id="resultName">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Giới tính:</span>
                                <span class="result-value" id="resultGender">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Tuổi:</span>
                                <span class="result-value" id="resultAge">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Địa chỉ:</span>
                                <span class="result-value" id="resultAddress">-</span>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <span class="result-label">Nghề nghiệp:</span>
                                <span class="result-value" id="resultOccupation">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Loại lao động:</span>
                                <span class="result-value" id="resultActivity">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Tình trạng sinh lý:</span>
                                <span class="result-value" id="resultPhysio">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">BMI:</span>
                                <span class="result-value" id="resultBMI">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3><i class="fas fa-heartbeat"></i> CHẨN ĐOÁN HUYẾT ÁP</h3>
                    <div class="result-item">
                        <span class="result-label">Huyết áp:</span>
                        <span class="result-value" id="resultBP">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Phân loại:</span>
                        <span id="resultBPCategory">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Mạch lúc nghỉ:</span>
                        <span class="result-value" id="resultHeartRate">-</span>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3><i class="fas fa-dumbbell"></i> KẾ HOẠCH TẬP LUYỆN ĐỀ XUẤT</h3>
                    <div class="result-grid">
                        <div>
                            <div class="result-item">
                                <span class="result-label">Môn thể thao sức bền:</span>
                                <span class="result-value" id="resultExerciseType">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Mức độ vận động:</span>
                                <span class="result-value" id="resultExerciseIntensity">-</span>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <span class="result-label">Thời lượng tập/buổi:</span>
                                <span class="result-value" id="resultExerciseDuration">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Tần suất tập:</span>
                                <span class="result-value" id="resultExerciseFrequency">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3><i class="fas fa-calculator"></i> TÍNH TOÁN NĂNG LƯỢNG</h3>
                    <div class="result-grid">
                        <div>
                            <div class="result-item">
                                <span class="result-label">Năng lượng chuyển hóa cơ bản (Ecb):</span>
                                <span class="result-value" id="resultBMR">-</span>
                            </div>
                            <div class="result-item">
                                <span class="result-label">Tổng năng lượng tiêu hao/buổi tập (Etl):</span>
                                <span class="result-value" id="resultExerciseCaloriesPerSession">-</span>
                            </div>
                        </div>
                        <div>
                            <div class="result-item">
                                <span class="result-label">Tổng năng lượng cần nạp/ngày:</span>
                                <span class="result-value" id="resultTotalEnergy">-</span>
                            </div>
                            <div class="result-item highlight">
                                <span class="result-label">CÔNG THỨC:</span>
                                <span class="result-value">Ecb + Etl = Tổng năng lượng</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3><i class="fas fa-utensils"></i> THỰC ĐƠN & KHẨU PHẦN ĐỀ XUẤT</h3>
                    <div class="nutrition-chart">
                        <div class="nutrition-item protein">
                            <div>CHẤT ĐẠM</div>
                            <div>15%</div>
                            <div id="proteinGrams">- g</div>
                        </div>
                        <div class="nutrition-item carbs">
                            <div>CHẤT BỘT</div>
                            <div>55%</div>
                            <div id="carbsGrams">- g</div>
                        </div>
                        <div class="nutrition-item fat">
                            <div>CHẤT BÉO</div>
                            <div>30%</div>
                            <div id="fatGrams">- g</div>
                        </div>
                    </div>
                    
                    <div class="meal-plan">
                        <h4><i class="fas fa-concierge-bell"></i> THỰC ĐƠN MẪU CHO MỘT NGÀY:</h4>
                        <div id="mealPlanDetails">
                            <!-- Meal items will be dynamically added here -->
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button id="printBtn" class="btn-print"><i class="fas fa-print"></i> IN KẾT QUẢ</button>
                    <button id="pdfBtn" class="btn-pdf"><i class="fas fa-file-pdf"></i> XUẤT PDF</button>
                    <button id="newConsultBtn"><i class="fas fa-user-plus"></i> TƯ VẤN MỚI</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Hệ thống tư vấn sức khỏe - Phòng khám Đa khoa YHTT & YHCT - PGs.TS.Bs. Võ Tường Kha</p>
            <p>Kết hợp Y học Hiện đại & Y học Cổ truyền để chăm sóc sức khỏe toàn diện</p>
        </div>
    </div>

    <script>
        // Lớp UserProfile
        class UserProfile {
            constructor(name, gender, dob, address, occupation, activityLevel, physioFactor, height, weight) {
                this.name = name;
                this.gender = gender;
                this.dob = dob;
                this.address = address;
                this.occupation = occupation;
                this.activityLevel = activityLevel;
                this.physioFactor = physioFactor;
                this.height = height;
                this.weight = weight;
                this.age = this.calculateAge();
                this.bmi = this.calculateBMI();
                this.bmr = this.calculateBMR();
            }
            
            calculateAge() {
                const today = new Date();
                const birthDate = new Date(this.dob);
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                return age;
            }
            
            calculateBMI() {
                return (this.weight / ((this.height / 100) ** 2)).toFixed(1);
            }
            
            calculateBMR() {
                if (this.gender === 'male') {
                    return 10 * this.weight + 6.25 * this.height - 5 * this.age + 5;
                } else {
                    return 10 * this.weight + 6.25 * this.height - 5 * this.age - 161;
                }
            }
        }
        
        // Lớp BloodPressureRecord
        class BloodPressureRecord {
            constructor(systolic, diastolic, heartRate) {
                this.systolic = systolic;
                this.diastolic = diastolic;
                this.heartRate = heartRate;
                this.category = this.classifyBloodPressure();
            }
            
            classifyBloodPressure() {
                if (this.systolic < 90 || this.diastolic < 60) {
                    return { text: "HUYẾT ÁP THẤP", class: "bp-normal", advice: "Nên nghỉ ngơi, bổ sung dinh dưỡng và theo dõi định kỳ" };
                } else if (this.systolic < 120 && this.diastolic < 80) {
                    return { text: "BÌNH THƯỜNG", class: "bp-normal", advice: "Duy trì lối sống lành mạnh và tập luyện đều đặn" };
                } else if (this.systolic >= 120 && this.systolic < 130 && this.diastolic < 80) {
                    return { text: "HUYẾT ÁP CAO TÂM THU", class: "bp-elevated", advice: "Cần điều chỉnh chế độ ăn và tăng cường vận động" };
                } else if ((this.systolic >= 130 && this.systolic < 140) || (this.diastolic >= 80 && this.diastolic < 90)) {
                    return { text: "TĂNG HUYẾT ÁP GIAI ĐOẠN 1", class: "bp-hypertension", advice: "Cần theo dõi và có thể cần dùng thuốc theo chỉ định" };
                } else if ((this.systolic >= 140 && this.systolic < 180) || (this.diastolic >= 90 && this.diastolic < 120)) {
                    return { text: "TĂNG HUYẾT ÁP GIAI ĐOẠN 2", class: "bp-hypertension", advice: "Cần điều trị tích cực và theo dõi chặt chẽ" };
                } else {
                    return { text: "CƠN TĂNG HUYẾT ÁP", class: "bp-hypertension", advice: "Cần cấp cứu y tế ngay lập tức" };
                }
            }
        }
        
        // Lớp ExerciseRecommendation
        class ExerciseRecommendation {
            constructor(bloodPressureCategory, age, bmi) {
                this.bloodPressureCategory = bloodPressureCategory;
                this.age = age;
                this.bmi = bmi;
                this.generateRecommendation();
            }
            
            generateRecommendation() {
                // Xác định môn tập dựa trên tình trạng huyết áp, tuổi và BMI
                if (this.bloodPressureCategory.includes("GIAI ĐOẠN 2") || this.bloodPressureCategory.includes("CƠN")) {
                    this.exerciseType = "ĐI BỘ CHẬM";
                    this.intensity = "NHẸ";
                    this.duration = 20;
                    this.frequency = "3-4 buổi/tuần";
                    this.metValue = 2.9;
                } else if (this.bloodPressureCategory.includes("GIAI ĐOẠN 1") || this.bloodPressureCategory.includes("CAO TÂM THU")) {
                    if (this.age > 50 || this.bmi > 25) {
                        this.exerciseType = "ĐI BỘ NHANH";
                        this.metValue = 4.3;
                    } else {
                        this.exerciseType = "XE ĐẠP CHẬM";
                        this.metValue = 4.0;
                    }
                    this.intensity = "VỪA";
                    this.duration = 30;
                    this.frequency = "4-5 buổi/tuần";
                } else {
                    if (this.age > 50 || this.bmi > 25) {
                        this.exerciseType = "BƠI LỘI";
                        this.metValue = 6.0;
                    } else {
                        this.exerciseType = "CHẠY BỘ";
                        this.metValue = 8.0;
                    }
                    this.intensity = "VỪA";
                    this.duration = 40;
                    this.frequency = "5-6 buổi/tuần";
                }
            }
            
            calculateCaloriesBurned(weight) {
                const durationHours = this.duration / 60;
                return this.metValue * weight * durationHours;
            }
        }
        
        // Lớp MealPlan
        class MealPlan {
            constructor(totalCalories) {
                this.totalCalories = totalCalories;
                this.proteinPercentage = 0.15;
                this.carbsPercentage = 0.55;
                this.fatPercentage = 0.30;
                this.calculateNutrients();
                this.generateSampleMeals();
            }
            
            calculateNutrients() {
                // Tính calories từ mỗi nhóm chất
                this.proteinCalories = this.totalCalories * this.proteinPercentage;
                this.carbsCalories = this.totalCalories * this.carbsPercentage;
                this.fatCalories = this.totalCalories * this.fatPercentage;
                
                // Chuyển đổi calories sang grams
                this.proteinGrams = this.proteinCalories / 4;
                this.carbsGrams = this.carbsCalories / 4;
                this.fatGrams = this.fatCalories / 9;
            }
            
            generateSampleMeals() {
                this.meals = [
                    {
                        name: "BỮA SÁNG",
                        items: [
                            { name: "Bánh mì đen", amount: "2 lát", calories: 160 },
                            { name: "Trứng luộc", amount: "2 quả", calories: 140 },
                            { name: "Sữa đậu nành", amount: "200ml", calories: 100 }
                        ]
                    },
                    {
                        name: "BỮA TRƯA",
                        items: [
                            { name: "Cơm gạo lứt", amount: "2 bát", calories: 240 },
                            { name: "Cá hồi áp chảo", amount: "150g", calories: 280 },
                            { name: "Rau củ luộc", amount: "200g", calories: 60 },
                            { name: "Chuối", amount: "1 quả", calories: 105 }
                        ]
                    },
                    {
                        name: "BỮA TỐI",
                        items: [
                            { name: "Cơm gạo lứt", amount: "1.5 bát", calories: 180 },
                            { name: "Đậu phụ sốt cà", amount: "150g", calories: 150 },
                            { name: "Salad rau xanh", amount: "150g", calories: 50 },
                            { name: "Táo", amount: "1 quả", calories: 95 }
                        ]
                    },
                    {
                        name: "BỮA PHỤ",
                        items: [
                            { name: "Hạt hạnh nhân", amount: "30g", calories: 180 },
                            { name: "Sữa chua không đường", amount: "1 hộp", calories: 100 }
                        ]
                    }
                ];
                
                // Tính tổng calories của thực đơn mẫu
                this.sampleTotalCalories = 0;
                this.meals.forEach(meal => {
                    meal.items.forEach(item => {
                        this.sampleTotalCalories += item.calories;
                    });
                });
                
                // Điều chỉnh tỷ lệ để khớp với tổng năng lượng cần
                const adjustmentFactor = this.totalCalories / this.sampleTotalCalories;
                this.meals.forEach(meal => {
                    meal.items.forEach(item => {
                        item.calories = Math.round(item.calories * adjustmentFactor);
                    });
                });
            }
        }
        
        // Lớp HypertensionConsultationSystem
        class HypertensionConsultationSystem {
            constructor() {
                this.userProfile = null;
                this.bloodPressure = null;
                this.exerciseRecommendation = null;
                this.mealPlan = null;
                this.activityFactors = {
                    'sedentary': { value: 1.2, name: 'Ít vận động' },
                    'light': { value: 1.375, name: 'Vận động nhẹ' },
                    'moderate': { value: 1.55, name: 'Vận động vừa phải' },
                    'high': { value: 1.725, name: 'Vận động nặng' },
                    'very_high': { value: 1.9, name: 'Vận động rất nặng' }
                };
                this.physioFactors = {
                    'normal': { value: 1.0, name: 'Bình thường' },
                    'pregnant': { value: 1.15, name: 'Mang thai' },
                    'breastfeeding': { value: 1.25, name: 'Cho con bú' },
                    'illness': { value: 1.2, name: 'Ốm bệnh/Nhiễm trùng' },
                    'post_surgery': { value: 1.25, name: 'Sau phẫu thuật/Chấn thương' },
                    'resting': { value: 0.95, name: 'Nghỉ ngơi (do bệnh)' }
                };
            }
            
            calculateTDEE() {
                const activityFactor = this.activityFactors[this.userProfile.activityLevel].value;
                const physioFactor = this.physioFactors[this.userProfile.physioFactor].value;
                return this.userProfile.bmr * activityFactor * physioFactor;
            }
            
            calculateTotalEnergyRequirement() {
                const tdee = this.calculateTDEE();
                
                // Tính năng lượng tiêu hao tập luyện mỗi ngày
                let sessionsPerWeek;
                if (this.exerciseRecommendation.frequency.includes('3-4')) {
                    sessionsPerWeek = 3.5;
                } else if (this.exerciseRecommendation.frequency.includes('4-5')) {
                    sessionsPerWeek = 4.5;
                } else {
                    sessionsPerWeek = 5.5;
                }
                
                const exerciseCaloriesPerDay = this.exerciseRecommendation.calculateCaloriesBurned(this.userProfile.weight) * 
                                             sessionsPerWeek / 7;
                
                return tdee + exerciseCaloriesPerDay;
            }
            
            getActivityFactorName() {
                return this.activityFactors[this.userProfile.activityLevel].name;
            }
            
            getPhysioFactorName() {
                return this.physioFactors[this.userProfile.physioFactor].name;
            }
        }
        
        // Khởi tạo hệ thống
        const system = new HypertensionConsultationSystem();
        
        // Xử lý sự kiện khi nhấn nút PHÂN TÍCH & TƯ VẤN
        document.getElementById('calculateBtn').addEventListener('click', function() {
            // Hiển thị loading
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            // Sử dụng setTimeout để hiển thị loading trong 1 giây
            setTimeout(function() {
                // Lấy thông tin từ form
                const name = document.getElementById('patientName').value;
                const gender = document.getElementById('patientGender').value;
                const dob = document.getElementById('patientDob').value;
                const address = document.getElementById('patientAddress').value;
                const occupation = document.getElementById('patientOccupation').value;
                const activityLevel = document.getElementById('activityLevel').value;
                const physioFactor = document.getElementById('physioFactor').value;
                const height = parseFloat(document.getElementById('patientHeight').value);
                const weight = parseFloat(document.getElementById('patientWeight').value);
                
                const systolic = parseInt(document.getElementById('systolic').value);
                const diastolic = parseInt(document.getElementById('diastolic').value);
                const heartRate = parseInt(document.getElementById('heartRate').value);
                
                // Kiểm tra dữ liệu đầu vào
                if (!name || !dob || !address || !occupation || !systolic || !diastolic || !heartRate || !height || !weight) {
                    alert('Vui lòng điền đầy đủ thông tin bắt buộc!');
                    document.getElementById('loadingSection').style.display = 'none';
                    return;
                }
                
                // Tạo các đối tượng
                system.userProfile = new UserProfile(name, gender, dob, address, occupation, activityLevel, physioFactor, height, weight);
                system.bloodPressure = new BloodPressureRecord(systolic, diastolic, heartRate);
                system.exerciseRecommendation = new ExerciseRecommendation(
                    system.bloodPressure.category.text, 
                    system.userProfile.age, 
                    system.userProfile.bmi
                );
                
                // Tính toán kết quả
                const bmr = system.userProfile.bmr;
                const totalEnergy = system.calculateTotalEnergyRequirement();
                const exerciseCaloriesPerSession = system.exerciseRecommendation.calculateCaloriesBurned(system.userProfile.weight);
                
                // Tạo kế hoạch bữa ăn
                system.mealPlan = new MealPlan(totalEnergy);
                
                // Hiển thị kết quả
                displayResults(system, bmr, totalEnergy, exerciseCaloriesPerSession);
                
                // Vẽ biểu đồ
                drawCharts(system.mealPlan, bmr, exerciseCaloriesPerSession, totalEnergy);
                
                // Hiển thị phần kết quả
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('loadingSection').style.display = 'none';
                
                // Cuộn đến phần kết quả
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        });
        
        // Xử lý sự kiện khi nhấn nút NHẬP LẠI
        document.getElementById('resetBtn').addEventListener('click', function() {
            // Reset form
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.type !== 'button') {
                    element.value = '';
                }
            });
            
            // Ẩn kết quả
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'none';
        });
        
        // Xử lý sự kiện khi nhấn nút IN KẾT QUẢ
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });
        
        // Xử lý sự kiện khi nhấn nút XUẤT PDF
        document.getElementById('pdfBtn').addEventListener('click', function() {
            // Hiển thị thông báo
            alert('Tính năng xuất PDF đang được phát triển. Vui lòng sử dụng tính năng in ấn.');
        });
        
        // Xử lý sự kiện khi nhấn nút TƯ VẤN MỚI
        document.getElementById('newConsultBtn').addEventListener('click', function() {
            // Reset form
            document.querySelectorAll('input, select, textarea').forEach(element => {
                if (element.type !== 'button') {
                    element.value = '';
                }
            });
            
            // Ẩn kết quả
            document.getElementById('resultsSection').style.display = 'none';
            
            // Cuộn lên đầu trang
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        
        // Hiển thị kết quả
        function displayResults(system, bmr, totalEnergy, exerciseCaloriesPerSession) {
            // Thông tin bệnh nhân
            document.getElementById('resultName').textContent = system.userProfile.name;
            document.getElementById('resultGender').textContent = system.userProfile.gender === 'male' ? 'Nam' : 'Nữ';
            document.getElementById('resultAge').textContent = system.userProfile.age + ' tuổi';
            document.getElementById('resultAddress').textContent = system.userProfile.address;
            document.getElementById('resultOccupation').textContent = system.userProfile.occupation;
            document.getElementById('resultActivity').textContent = system.getActivityFactorName();
            document.getElementById('resultPhysio').textContent = system.getPhysioFactorName();
            document.getElementById('resultBMI').textContent = system.userProfile.bmi;
            
            // Chẩn đoán huyết áp
            document.getElementById('resultBP').textContent = `${system.bloodPressure.systolic}/${system.bloodPressure.diastolic} mmHg`;
            
            const bpCategoryElement = document.getElementById('resultBPCategory');
            bpCategoryElement.textContent = system.bloodPressure.category.text;
            bpCategoryElement.className = `bp-status ${system.bloodPressure.category.class}`;
            
            document.getElementById('resultHeartRate').textContent = system.bloodPressure.heartRate + ' bpm';
            
            // Kế hoạch tập luyện
            document.getElementById('resultExerciseType').textContent = system.exerciseRecommendation.exerciseType;
            document.getElementById('resultExerciseIntensity').textContent = system.exerciseRecommendation.intensity;
            document.getElementById('resultExerciseDuration').textContent = system.exerciseRecommendation.duration + ' phút';
            document.getElementById('resultExerciseFrequency').textContent = system.exerciseRecommendation.frequency;
            
            // Tính toán năng lượng
            document.getElementById('resultBMR').textContent = bmr.toFixed(1) + ' kcal';
            document.getElementById('resultExerciseCaloriesPerSession').textContent = exerciseCaloriesPerSession.toFixed(1) + ' kcal';
            document.getElementById('resultTotalEnergy').textContent = totalEnergy.toFixed(1) + ' kcal';
            
            // Khẩu phần dinh dưỡng
            document.getElementById('proteinGrams').textContent = system.mealPlan.proteinGrams.toFixed(1) + ' g';
            document.getElementById('carbsGrams').textContent = system.mealPlan.carbsGrams.toFixed(1) + ' g';
            document.getElementById('fatGrams').textContent = system.mealPlan.fatGrams.toFixed(1) + ' g';
            
            // Hiển thị thực đơn mẫu
            const mealPlanDetails = document.getElementById('mealPlanDetails');
            mealPlanDetails.innerHTML = '';
            
            system.mealPlan.meals.forEach(meal => {
                const mealElement = document.createElement('div');
                mealElement.className = 'meal-item';
                
                let mealHTML = `<div><strong>${meal.name}</strong></div><div>`;
                let totalMealCalories = 0;
                
                meal.items.forEach(item => {
                    mealHTML += `<div>${item.name} (${item.amount})</div>`;
                    totalMealCalories += item.calories;
                });
                
                mealHTML += `</div><div><strong>${totalMealCalories} kcal</strong></div>`;
                mealElement.innerHTML = mealHTML;
                mealPlanDetails.appendChild(mealElement);
            });
        }
        
        // Vẽ biểu đồ
        function drawCharts(mealPlan, bmr, exerciseCalories, totalEnergy) {
            const nutritionCtx = document.getElementById('nutritionChart').getContext('2d');
            const energyCtx = document.getElementById('energyChart').getContext('2d');
            
            // Biểu đồ phân bổ dinh dưỡng
            if (window.nutritionChart) {
                window.nutritionChart.destroy();
            }
            window.nutritionChart = new Chart(nutritionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Chất đạm (15%)', 'Chất bột (55%)', 'Chất béo (30%)'],
                    datasets: [{
                        data: [15, 55, 30],
                        backgroundColor: ['#3498db', '#2ecc71', '#f39c12'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Phân Bổ Dinh Dưỡng'
                        }
                    }
                }
            });
            
            // Biểu đồ năng lượng
            if (window.energyChart) {
                window.energyChart.destroy();
            }
            window.energyChart = new Chart(energyCtx, {
                type: 'bar',
                data: {
                    labels: ['Năng lượng cơ bản (Ecb)', 'Tập luyện (Etl)', 'Tổng năng lượng cần'],
                    datasets: [{
                        label: 'Năng lượng (kcal)',
                        data: [bmr, exerciseCalories, totalEnergy],
                        backgroundColor: ['#2c5530', '#4a7c59', '#8fb996'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Năng lượng (kcal)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Phân Bổ Năng Lượng'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
